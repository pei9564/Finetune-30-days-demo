# Finetune-30-days â€” LoRA è¨“ç·´èˆ‡å¯¦é©—ç®¡ç†

æ­¤å°ˆæ¡ˆæä¾›ä¸€å€‹å®Œæ•´çš„ **LoRA å¾®èª¿ç³»çµ±**ï¼Œæ”¯æ´ M3 æ™¶ç‰‡ (MPS)ã€NVIDIA GPU (CUDA) èˆ‡ CPUã€‚

**ä¸»è¦ç‰¹é»**ï¼š
- ğŸš€ æ”¯æ´åŒæ­¥ï¼ˆæœ¬åœ°ï¼‰èˆ‡éåŒæ­¥ï¼ˆåˆ†æ•£å¼ï¼‰è¨“ç·´
- ğŸ“Š å®Œæ•´çš„è³‡æ–™ç‰ˆæœ¬ç®¡ç†èˆ‡é©—è­‰æ©Ÿåˆ¶
- ğŸ¯ å¯¦é©—çµæœè‡ªå‹•ä¿å­˜èˆ‡è¿½è¹¤
- ğŸŒ ç¶²é ç•Œé¢æ”¯æ´ä»»å‹™æäº¤èˆ‡é€²åº¦ç›£æ§
- ğŸ”„ åŸºæ–¼ Celery + Redis çš„éåŒæ­¥ä»»å‹™ç³»çµ±
- ğŸ“ çµæ§‹åŒ–çš„é…ç½®ç®¡ç†ï¼ˆPydantic + YAMLï¼‰
- â˜¸ï¸ å®Œæ•´çš„ Kubernetes éƒ¨ç½²æ”¯æ´
- ğŸ³ å„ªåŒ–çš„å¤šéšæ®µ Docker æ§‹å»º
- ğŸ“ˆ æ•ˆèƒ½ç›£æ§èˆ‡åˆ†æå·¥å…·
- ğŸ” JWT èªè­‰èˆ‡ RBAC æ¬Šé™æ§åˆ¶
- ğŸ“‹ å®Œæ•´çš„å¯©è¨ˆæ—¥èªŒèˆ‡è¿½è¹¤ç³»çµ±
- ğŸ§ª å…¨é¢çš„å–®å…ƒæ¸¬è©¦è¦†è“‹

---

## ğŸ”„ ç³»çµ±äº’å‹•æµç¨‹

```mermaid
sequenceDiagram
    participant U as ä½¿ç”¨è€…
    participant UI as Streamlit UI
    participant API as FastAPI
    participant C as Celery Worker
    participant T as è¨“ç·´ç¨‹å¼
    participant DB as SQLite DB
    participant R as Redis

    U->>UI: å¡«å¯«å¯¦é©—åƒæ•¸ä¸¦æäº¤
    UI->>API: POST /train (config)
    API->>C: æäº¤ Celery ä»»å‹™
    C->>R: ä»»å‹™å…¥éšŠ (task_id)
    API-->>UI: å›å‚³ task_id

    loop ä»»å‹™è¼ªè©¢
        UI->>API: GET /task/{task_id}
        API->>R: æŸ¥è©¢ç‹€æ…‹
        R-->>API: è¿”å› PENDING/STARTED
        API-->>UI: æ›´æ–° UI Stepper ç‹€æ…‹
    end

    C->>T: åŸ·è¡Œ train_lora_v2.py
    T->>DB: å¯«å…¥å¯¦é©—è¨˜éŒ„
    T->>R: æ›´æ–°ä»»å‹™çµæœ (SUCCESS)
    UI->>API: æœ€å¾ŒæŸ¥è©¢ /task/{task_id}
    API-->>UI: è¿”å› SUCCESS + å¯¦é©—çµæœ
```

## ğŸ”„ ç³»çµ±æ¶æ§‹

```mermaid
graph TB
    subgraph Training["è¨“ç·´æµç¨‹"]
        Train[train_lora_v2.py] --> |ä¿å­˜å¯¦é©—çµæœ| Results[(results/)]
        Results --> |åŒ…å«| Config[config.yaml]
        Results --> |åŒ…å«| Model[final_model/]
    end

    subgraph Inference["æ¨è«–æœå‹™"]
        API[inference_api.py] --> |è®€å–é…ç½®| Config
        API --> |è¼‰å…¥æ¬Šé‡| Model
        API --> |å›æ‡‰è«‹æ±‚| Response[JSON Response]
    end

    subgraph Client["å®¢æˆ¶ç«¯"]
        CLI[make serve] --> |å•Ÿå‹•| API
        Test[make predict-*] --> |æ¸¬è©¦| API
    end

    Results --> |å¯¦é©—è¨˜éŒ„| DB[(experiments.db)]
```

## ğŸ” èªè­‰èˆ‡æˆæ¬Šæ©Ÿåˆ¶

æœ¬ç³»çµ±æ¡ç”¨ JWT (JSON Web Token) é€²è¡Œèªè­‰å’Œæˆæ¬Šç®¡ç†ï¼Œå¯¦ç¾äº†å®Œæ•´çš„ RBACï¼ˆåŸºæ–¼è§’è‰²çš„è¨ªå•æ§åˆ¶ï¼‰ã€‚

### èªè­‰æµç¨‹

```mermaid
sequenceDiagram
    participant C as å®¢æˆ¶ç«¯
    participant A as API
    participant J as JWT Utils
    
    C->>A: POST /login (username, password)
    A->>A: é©—è­‰ç”¨æˆ¶æ†‘è­‰
    A->>J: create_token(user_id, role)
    J-->>A: JWT Token
    A-->>C: {token, user_id, role}
    
    Note over C,A: å¾ŒçºŒè«‹æ±‚
    C->>A: API è«‹æ±‚ + Bearer Token
    A->>J: get_current_user(token)
    J-->>A: user_info æˆ– 401/403 éŒ¯èª¤
```

### æ¬Šé™æ§åˆ¶

ç³»çµ±å¯¦ç¾äº†ä¸‰å±¤æ¬Šé™æ§åˆ¶ï¼š

1. **åŸºæœ¬èªè­‰** (`get_current_user`)ï¼š
   - é©—è­‰ Bearer Token çš„å­˜åœ¨å’Œæœ‰æ•ˆæ€§
   - è§£æç”¨æˆ¶èº«ä»½å’Œè§’è‰²ä¿¡æ¯
   - è™•ç† token éæœŸå’Œç„¡æ•ˆæƒ…æ³

2. **ç®¡ç†å“¡æ¬Šé™** (`check_admin`)ï¼š
   - é™åˆ¶åªæœ‰ç®¡ç†å“¡å¯ä»¥è¨ªå•çš„ç«¯é»
   - ç”¨æ–¼æ•æ„Ÿæ“ä½œï¼ˆå¦‚æŸ¥çœ‹æ‰€æœ‰å¯¦é©—è¨˜éŒ„ï¼‰
   - è¿”å› 403 éŒ¯èª¤çµ¦éç®¡ç†å“¡ç”¨æˆ¶

3. **è³‡æºæ‰€æœ‰æ¬Š** (`check_task_owner`)ï¼š
   - ç¢ºä¿ç”¨æˆ¶åªèƒ½è¨ªå•è‡ªå·±çš„è³‡æº
   - ç®¡ç†å“¡å¯ä»¥è¨ªå•æ‰€æœ‰è³‡æº
   - åŸºæ–¼è³‡æº ID å‰ç¶´é©—è­‰æ‰€æœ‰æ¬Š

### API ç«¯é»æ¬Šé™

| ç«¯é» | æ–¹æ³• | æ¬Šé™è¦æ±‚ | èªªæ˜ |
|------|------|----------|------|
| `/login` | POST | ç„¡ | ç”¨æˆ¶ç™»å…¥ï¼Œè¿”å› JWT token |
| `/train` | POST | å·²èªè­‰ç”¨æˆ¶ | æäº¤è¨“ç·´ä»»å‹™ |
| `/task/{task_id}` | GET | ä»»å‹™æ‰€æœ‰è€… | æŸ¥è©¢ä»»å‹™ç‹€æ…‹ |
| `/experiments` | GET | ç®¡ç†å“¡ | åˆ—å‡ºæ‰€æœ‰å¯¦é©—è¨˜éŒ„ |
| `/experiments/stats` | GET | ç®¡ç†å“¡ | ç²å–å¯¦é©—çµ±è¨ˆä¿¡æ¯ |
| `/experiments/{id}` | GET | ä»»å‹™æ‰€æœ‰è€… | æŸ¥è©¢å–®å€‹å¯¦é©—è¨˜éŒ„ |
| `/audit/logs` | GET | ç®¡ç†å“¡ | æŸ¥è©¢å¯©è¨ˆæ—¥èªŒ |

### JWT é…ç½®

```python
# JWT ç›¸é—œé…ç½®
JWT_SECRET = "your-secret-key"  # ç”Ÿç”¢ç’°å¢ƒæ‡‰ä½¿ç”¨ç’°å¢ƒè®Šæ•¸
JWT_ALGORITHM = "HS256"         # åŠ å¯†ç®—æ³•
TOKEN_EXPIRE_MINUTES = 30       # token æœ‰æ•ˆæœŸ
```

### å®‰å…¨æ€§è€ƒæ…®

1. **Token ç®¡ç†**ï¼š
   - è‡ªå‹•éæœŸæ©Ÿåˆ¶ï¼ˆ30åˆ†é˜ï¼‰
   - ç„¡ç‹€æ…‹è¨­è¨ˆï¼Œä¸éœ€è¦æœå‹™å™¨å­˜å„²
   - æ”¯æ´ token åˆ·æ–°ï¼ˆå¾…å¯¦ç¾ï¼‰

2. **éŒ¯èª¤è™•ç†**ï¼š
   - 401ï¼šæœªèªè­‰æˆ– token éæœŸ
   - 403ï¼šæ¬Šé™ä¸è¶³
   - è©³ç´°çš„éŒ¯èª¤è¨Šæ¯

3. **æœ€ä½³å¯¦è¸**ï¼š
   - ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ç®¡ç†æ•æ„Ÿä¿¡æ¯
   - HTTPS å‚³è¼¸ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
   - è«‹æ±‚é »ç‡é™åˆ¶ï¼ˆå¾…å¯¦ç¾ï¼‰

---

## ğŸ“‚ å°ˆæ¡ˆçµæ§‹

```
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                    # FastAPI ä¸»æ‡‰ç”¨ç¨‹å¼
â”‚   â”œâ”€â”€ config.py                  # é…ç½®å®šç¾©èˆ‡é©—è­‰
â”‚   â”œâ”€â”€ db.py                      # è³‡æ–™åº«æ¨¡å‹èˆ‡æ“ä½œ
â”‚   â”œâ”€â”€ inference_api.py           # æƒ…æ„Ÿåˆ†é¡æ¨è«–æœå‹™
â”‚   â”œâ”€â”€ logger_config.py           # æ—¥èªŒé…ç½®èˆ‡ç®¡ç†
â”‚   â”œâ”€â”€ settings.py                # ç³»çµ±è¨­å®šèˆ‡å¸¸æ•¸
â”‚   â”œâ”€â”€ stepper_ui.py             # Streamlit UI ä»‹é¢
â”‚   â”œâ”€â”€ train_lora_v2.py          # LoRA è¨“ç·´ä¸»ç¨‹å¼
â”‚   â”œâ”€â”€ auth/                     # èªè­‰èˆ‡æˆæ¬Šæ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ jwt_utils.py          # JWT Token è™•ç†
â”‚   â”‚   â””â”€â”€ audit_log.py          # å¯©è¨ˆæ—¥èªŒåŠŸèƒ½
â”‚   â”œâ”€â”€ api/                      # API è·¯ç”±æ¨¡çµ„
â”‚   â”‚   â””â”€â”€ routes/               # è·¯ç”±å®šç¾©
â”‚   â”‚       â””â”€â”€ audit.py         # å¯©è¨ˆæ—¥èªŒ API è·¯ç”±
â”‚   â”œâ”€â”€ data_management/          # è³‡æ–™ç®¡ç†æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ data_validator.py     # è³‡æ–™é›†é©—è­‰èˆ‡å“è³ªæª¢æŸ¥
â”‚   â”‚   â”œâ”€â”€ dataset_analyzer.py   # è³‡æ–™é›†åˆ†å¸ƒèˆ‡çµ±è¨ˆåˆ†æ
â”‚   â”‚   â””â”€â”€ version_manager.py    # è³‡æ–™é›†ç‰ˆæœ¬èˆ‡è®Šæ›´è¿½è¹¤
â”‚   â”œâ”€â”€ monitoring/              # ç›£æ§æ¨¡çµ„
â”‚   â”‚   â””â”€â”€ performance.py       # ç³»çµ±æ•ˆèƒ½èˆ‡è³‡æºç›£æ§
â”‚   â”œâ”€â”€ tasks/                   # ä»»å‹™è™•ç†æ¨¡çµ„
â”‚   â”‚   â””â”€â”€ training.py          # Celery è¨“ç·´ä»»å‹™
â”‚   â””â”€â”€ tools/                   # å·¥å…·æ¨¡çµ„
â”‚       â”œâ”€â”€ analyze_metrics.py   # å¯¦é©—æŒ‡æ¨™åˆ†æå·¥å…·
â”‚       â””â”€â”€ checkpoint_manager.py # æª¢æŸ¥é»ç®¡ç†
â”œâ”€â”€ config/                      # é…ç½®æ–‡ä»¶ç›®éŒ„
â”‚   â”œâ”€â”€ default.yaml            # é è¨­è¨“ç·´é…ç½®
â”‚   â”œâ”€â”€ albert.yaml             # Albert æ¨¡å‹é…ç½®
â”‚   â”œâ”€â”€ bert_chinese.yaml       # ä¸­æ–‡ BERT é…ç½®
â”‚   â”œâ”€â”€ distilbert_optimized.yaml # å„ªåŒ–çš„ DistilBERT é…ç½®
â”‚   â””â”€â”€ roberta.yaml            # RoBERTa æ¨¡å‹é…ç½®
â”œâ”€â”€ results/                     # å¯¦é©—çµæœç›®éŒ„
â”‚   â”œâ”€â”€ experiments.db          # SQLite å¯¦é©—è¨˜éŒ„è³‡æ–™åº«
â”‚   â””â”€â”€ {å¯¦é©—åç¨±}/            # ç¨ç«‹å¯¦é©—ç›®éŒ„
â”‚       â”œâ”€â”€ config.yaml        # å¯¦é©—å®Œæ•´é…ç½®
â”‚       â”œâ”€â”€ metrics.json       # è¨“ç·´è©•ä¼°æŒ‡æ¨™
â”‚       â”œâ”€â”€ logs.txt          # è¨“ç·´æ—¥èªŒ
â”‚       â””â”€â”€ artifacts/        # æ¨¡å‹èˆ‡æª¢æŸ¥é»
â”‚           â”œâ”€â”€ checkpoint-*/ # è¨“ç·´ä¸­é–“æª¢æŸ¥é»
â”‚           â””â”€â”€ final_model/  # æœ€çµ‚è¨“ç·´æ¨¡å‹
â”œâ”€â”€ data/                       # è³‡æ–™é›†ç›®éŒ„
â”‚   â”œâ”€â”€ datasets/              # è¨“ç·´è³‡æ–™é›†
â”‚   â””â”€â”€ metadata/              # è³‡æ–™é›†å…ƒè³‡æ–™
â”œâ”€â”€ k8s/                       # Kubernetes éƒ¨ç½²é…ç½®
â”‚   â”œâ”€â”€ manifests/             # K8s è³‡æºæ¸…å–®
â”‚   â””â”€â”€ k8s.sh                 # K8s éƒ¨ç½²è…³æœ¬
â”œâ”€â”€ requirements.txt           # Python ä¾è³´æ¸…å–®
â”œâ”€â”€ docker-compose.yml         # Docker Compose é…ç½®
â”œâ”€â”€ Dockerfile                 # Docker æ˜ åƒæ§‹å»ºé…ç½®
â”œâ”€â”€ Makefile                   # å°ˆæ¡ˆç®¡ç†æŒ‡ä»¤
â””â”€â”€ README.md                  # å°ˆæ¡ˆèªªæ˜æ–‡ä»¶
```

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### ç’°å¢ƒè¨­ç½®

1. **è¤‡è£½ç’°å¢ƒè®Šæ•¸æ–‡ä»¶**ï¼š
   ```bash
   cp .env.example .env
   ```

2. **ç·¨è¼¯ç’°å¢ƒè®Šæ•¸**ï¼ˆå¯é¸ï¼‰ï¼š
   ```bash
   # ç·¨è¼¯ .env æ–‡ä»¶ä¾†è‡ªå®šç¾©é…ç½®
   nano .env
   ```

   ä¸»è¦é…ç½®é …ç›®ï¼š
   - `REDIS_PORT`: Redis ç«¯å£ï¼ˆé è¨­ï¼š6379ï¼‰
   - `API_PORT`: API æœå‹™ç«¯å£ï¼ˆé è¨­ï¼š8000ï¼‰
   - `UI_PORT`: UI ç•Œé¢ç«¯å£ï¼ˆé è¨­ï¼š8501ï¼‰
   - `TZ`: æ™‚å€è¨­å®šï¼ˆé è¨­ï¼šAsia/Taipeiï¼‰

### éƒ¨ç½²æ–¹å¼

1. **æœ¬åœ°ç›´æ¥è¨“ç·´**ï¼š
```bash
make setup-conda   # å»ºç«‹ Conda ç’°å¢ƒï¼ˆè‡ªå‹•åµæ¸¬ GPU/MPS/CPUï¼‰
make run-local     # ä½¿ç”¨é è¨­é…ç½®é–‹å§‹è¨“ç·´
make logs-local    # æŸ¥çœ‹è¨“ç·´é€²åº¦
```

2. **Docker å®¹å™¨éƒ¨ç½²**ï¼š
```bash
# å•Ÿå‹•æ‰€æœ‰æœå‹™
make start-services  # å•Ÿå‹• Redisã€Workerã€APIã€UI æœå‹™

# ä½¿ç”¨ç¶²é ç•Œé¢ï¼ˆæ¨è–¦ï¼‰
# è¨ªå• http://localhost:8501
```

3. **Kubernetes éƒ¨ç½²**ï¼ˆæ–°å¢ï¼‰ï¼š
```bash
# å¿«é€Ÿéƒ¨ç½²ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
make k8s-quick-deploy  # ä¸€éµéƒ¨ç½²ï¼ˆå»ºæ§‹+éƒ¨ç½²ï¼‰

# é–‹å•Ÿæœå‹™è¨ªå•
make k8s-port-forward  # è½‰ç™¼æœå‹™ç«¯å£åˆ°æœ¬åœ°

# ç›£æ§èˆ‡ç®¡ç†
make k8s-dashboard    # é–‹å•Ÿ K8s å„€è¡¨æ¿
make k8s-status       # æŸ¥çœ‹éƒ¨ç½²ç‹€æ…‹
make k8s-logs service=worker  # æŸ¥çœ‹ç‰¹å®šæœå‹™æ—¥èªŒ

# æ“´å±•æœå‹™
make k8s-scale service=worker replicas=3  # èª¿æ•´ worker æ•¸é‡
```

> ğŸ’¡ **æœå‹™èªªæ˜**ï¼š
> - **Redis (localhost:6379)**ï¼šä»»å‹™ä½‡åˆ—èˆ‡çµæœå­˜å„²
> - **FastAPI (localhost:8000)**ï¼šREST API æœå‹™
> - **Streamlit UI (localhost:8501)**ï¼šç¶²é æ“ä½œç•Œé¢
>   - æ”¯æ´æ‰€æœ‰ default.yaml ä¸­çš„åƒæ•¸é…ç½®
>   - ç›´æ¥å‚³éè¨“ç·´é…ç½®ï¼ˆä¸å†ä½¿ç”¨è‡¨æ™‚æ–‡ä»¶ï¼‰
>   - å³æ™‚é¡¯ç¤ºè¨“ç·´é€²åº¦ï¼ˆæ¯ 2 ç§’æ›´æ–°ï¼‰
>   - å¯¦é©—è¨˜éŒ„æŸ¥çœ‹èˆ‡ç®¡ç†

### æ¸¬è©¦é–‹ç™¼

æœ¬å°ˆæ¡ˆä½¿ç”¨ pytest é€²è¡Œå–®å…ƒæ¸¬è©¦ï¼Œä¸»è¦æ¸¬è©¦ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **API ç«¯é»æ¸¬è©¦** (`app/tests/test_api.py`)ï¼š
   ```bash
   # é‹è¡Œæ‰€æœ‰æ¸¬è©¦
   make test
   
   # è©³ç´°æ¨¡å¼ï¼ˆé¡¯ç¤ºæ¸¬è©¦éç¨‹ï¼‰
   make test-v
   ```

   æ¸¬è©¦è¦†è“‹ï¼š
   - åŸºæœ¬åŠŸèƒ½ï¼šè¨“ç·´ä»»å‹™æäº¤ã€ç‹€æ…‹æŸ¥è©¢
   - éŒ¯èª¤è™•ç†ï¼šç„¡æ•ˆé…ç½®ã€ç„¡æ•ˆä»»å‹™ ID
   - ç•°å¸¸è™•ç†ï¼šè¨˜æ†¶é«”ä¸è¶³ã€æ•¸æ“šé›†éŒ¯èª¤

2. **è¨“ç·´é‚è¼¯æ¸¬è©¦** (`app/tests/test_training.py`)ï¼š
   - æ•¸æ“šé›†è™•ç†ï¼šç©ºæ•¸æ“šé›†ã€ç¼ºå¤±åˆ†å‰²
   - ç³»çµ±è³‡æºï¼šè¨˜æ†¶é«”ç›£æ§ã€OOM è™•ç†
   - åºåˆ—è™•ç†ï¼šè¶…é•·æ–‡æœ¬æˆªæ–·

3. **èªè­‰èˆ‡æˆæ¬Šæ¸¬è©¦** (`app/tests/test_auth.py`)ï¼š
   - JWT Token å‰µå»ºèˆ‡é©—è­‰
   - æ¬Šé™æª¢æŸ¥ï¼šç®¡ç†å“¡ vs æ™®é€šç”¨æˆ¶
   - Token éæœŸè™•ç†
   - éŒ¯èª¤è™•ç†ï¼šç„¡æ•ˆ tokenã€æ¬Šé™ä¸è¶³

4. **å¯©è¨ˆæ—¥èªŒæ¸¬è©¦** (`app/tests/test_audit.py`)ï¼š
   - å¯©è¨ˆæ—¥èªŒä¿å­˜åŠŸèƒ½
   - æ—¥èªŒæŸ¥è©¢èˆ‡ç¯©é¸
   - ä¸­é–“ä»¶åŠŸèƒ½æ¸¬è©¦
   - API ç«¯é»æ¬Šé™é©—è­‰

> ğŸ’¡ **æ¸¬è©¦èªªæ˜**ï¼š
> - ä½¿ç”¨ mock éš”é›¢å¤–éƒ¨ä¾è³´ï¼ˆRedisã€Celeryã€è³‡æ–™åº«ï¼‰
> - è‡ªå‹•æª¢æ¸¬ç³»çµ±ç’°å¢ƒï¼ˆMPS/CUDA/CPUï¼‰
> - åŒ…å«å®Œæ•´çš„éŒ¯èª¤è™•ç†æ¸¬è©¦ç”¨ä¾‹
> - å¯©è¨ˆæ—¥èªŒåŠŸèƒ½åœ¨æ¸¬è©¦ä¸­è¢« mockï¼Œé¿å…ç”¢ç”Ÿå¯¦éš›è¨˜éŒ„

### è‡ªå®šç¾©è¨“ç·´

1. **ä½¿ç”¨æ•ˆèƒ½ç›£æ§**ï¼š
   åœ¨è¨“ç·´éç¨‹ä¸­è‡ªå‹•å•Ÿç”¨ `PerformanceMonitor` ä»¥æ”¶é›†ç³»çµ±å’Œè¨“ç·´æŒ‡æ¨™ã€‚

2. **åˆ†æå¯¦é©—æ•¸æ“š**ï¼š
   ä½¿ç”¨ `analyze_metrics.py` ä¾†ç”Ÿæˆå¯¦é©—æ¯”è¼ƒå ±å‘Šã€‚
   ```bash
   make analyze-by-model
   ```

3. **ä¿®æ”¹é è¨­é…ç½®**ï¼š
   ç›´æ¥ç·¨è¼¯ `config/default.yaml`

4. **ä½¿ç”¨å‘½ä»¤åˆ—åƒæ•¸**ï¼š
   ```bash
   python app/train_lora_v2.py \
     --experiment_name "custom_test" \
     --learning_rate 0.001 \
     --epochs 3 \
     --train_samples 1000
   ```

### å¸¸ç”¨åƒæ•¸

```yaml
# åœ¨ config/default.yaml ä¸­å¯èª¿æ•´ï¼š

model:
  name: "distilbert-base-uncased"
  num_labels: 2

training:
  learning_rate: 5.0e-4
  num_train_epochs: 1
  per_device_train_batch_size: 2

lora:
  r: 8
  lora_alpha: 16
  target_modules: ["q_lin", "v_lin"]
  lora_dropout: 0.1
```

---

## ğŸ“Š å¯¦é©—ç®¡ç†

### å¯¦é©—ç›®éŒ„çµæ§‹

æ¯æ¬¡è¨“ç·´æœƒè‡ªå‹•å‰µå»ºå¯¦é©—å°ˆå±¬ç›®éŒ„ï¼š
```
results/
â””â”€â”€ {å¯¦é©—åç¨±}/             # å¯¦é©—ç›®éŒ„
    â”œâ”€â”€ config.yaml         # å¯¦é©—é…ç½®ï¼ˆå«åŸºç¤æ¨¡å‹è¨­å®šï¼‰
    â”œâ”€â”€ metrics.json        # è©•ä¼°æŒ‡æ¨™
    â””â”€â”€ artifacts/
        â””â”€â”€ final_model/    # è¨“ç·´å®Œæˆçš„æ¨¡å‹ï¼ˆLoRA æ¬Šé‡ï¼‰
```

- **ç³»çµ±æ—¥èªŒ**ï¼šè¨˜éŒ„è¨­å‚™ã€æ¨¡å‹è¼‰å…¥ã€è³‡æ–™è™•ç†ç­‰ç³»çµ±æ“ä½œ
- **è¨“ç·´é€²åº¦**ï¼šè¨˜éŒ„æ¯å€‹æ­¥é©Ÿçš„æå¤±å€¼ã€å­¸ç¿’ç‡ã€è©•ä¼°æŒ‡æ¨™ç­‰
- **å¯¦é©—é…ç½®**ï¼šåŒ…å«æ‰€æœ‰åƒæ•¸è¨­å®šï¼Œç¢ºä¿å¯¦é©—å¯é‡ç¾
- **è©•ä¼°æŒ‡æ¨™**ï¼šä¿å­˜æœ€çµ‚çš„è¨“ç·´æ™‚é–“ã€æº–ç¢ºç‡ç­‰çµæœ

### Checkpoint ä¿ç•™ç­–ç•¥

ç‚ºäº†æœ‰æ•ˆç®¡ç†è¨“ç·´è³‡æºï¼Œç³»çµ±æœƒè‡ªå‹•åŸ·è¡Œä»¥ä¸‹æ¸…ç†è¦å‰‡ï¼š

- æ¯å€‹å¯¦é©—ç›®éŒ„ä¸‹åªä¿ç•™ä¸‰å€‹é—œéµ checkpointsï¼š
  1. æœ€ä½³è©•ä¼°æº–ç¢ºç‡çš„ checkpointï¼ˆç”¨æ–¼æœ€çµ‚æ¨¡å‹ï¼‰
  2. æœ€å¾Œä¸€å€‹ checkpointï¼ˆç”¨æ–¼æ¢å¾©è¨“ç·´ï¼‰
  3. è¨“ç·´æ™‚é–“æœ€çŸ­çš„ checkpointï¼ˆç”¨æ–¼å¿«é€Ÿå¯¦é©—ï¼‰
- æ¸…ç†æ™‚æ©Ÿï¼šæ¯æ¬¡ä¿å­˜æ–°çš„ checkpoint å¾Œè‡ªå‹•åŸ·è¡Œ
- æ¸…ç†æ–¹å¼ï¼šåˆ†æ `trainer_state.json` ä¸­çš„è©•ä¼°æŒ‡æ¨™ï¼Œä¿ç•™ç¬¦åˆæ¢ä»¶çš„æª”æ¡ˆ

### å¯¦é©—è¿½è¹¤

æä¾›å¤šç¨®æ–¹å¼æŸ¥çœ‹å¯¦é©—è¨˜éŒ„ï¼š

1. **ç¶²é ç•Œé¢**ï¼ˆæ¨è–¦ï¼‰ï¼š
   - è¨ªå• http://localhost:8501
   - åˆ‡æ›åˆ°ã€Œå¯¦é©—è¨˜éŒ„ã€é ç±¤
   - æ”¯æ´ç¯©é¸ã€æ’åºã€çµ±è¨ˆåŠŸèƒ½
   - å³æ™‚æ›´æ–°å¯¦é©—ç‹€æ…‹

2. **å‘½ä»¤åˆ—å·¥å…·**ï¼š
   ```bash
   # æŸ¥çœ‹å¯¦é©—è¨˜éŒ„ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
   make db-list
   
   # æŸ¥çœ‹æœ€æ–°å¯¦é©—çš„è¨“ç·´é€²åº¦
   make logs-local
   ```

3. **REST API**ï¼š
   ```bash
   # åˆ—å‡ºæ‰€æœ‰å¯¦é©—ï¼ˆæ”¯æ´ç¯©é¸å’Œæ’åºï¼‰
   curl "http://localhost:8000/experiments?min_accuracy=0.8&sort_by=eval_accuracy&desc=true"

   # æŸ¥è©¢å–®ä¸€å¯¦é©—
   curl http://localhost:8000/experiments/{experiment_id}

   # ç²å–å¯¦é©—çµ±è¨ˆ
   curl http://localhost:8000/experiments/stats

   # æŸ¥è©¢å¯©è¨ˆæ—¥èªŒï¼ˆéœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼‰
   curl -H "Authorization: Bearer {admin_token}" \
        "http://localhost:8000/audit/logs?user_id=test_user&limit=10"
   ```

   æ”¯æ´çš„ç¯©é¸æ¢ä»¶ï¼š
   - **å¯¦é©—è¨˜éŒ„**ï¼š
     - `name`ï¼šå¯¦é©—åç¨±ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
     - `min_accuracy`ï¼šæœ€ä½æº–ç¢ºç‡
     - `max_runtime`ï¼šæœ€é•·è¨“ç·´æ™‚é–“
     - `start_date`/`end_date`ï¼šæ™‚é–“ç¯„åœ
     - `sort_by`ï¼šæ’åºæ¬„ä½ï¼ˆcreated_at/name/train_runtime/eval_accuracyï¼‰
     - `desc`ï¼šæ˜¯å¦é™åºæ’åº
     - `limit`ï¼šè¿”å›æ•¸é‡é™åˆ¶
   - **å¯©è¨ˆæ—¥èªŒ**ï¼š
     - `user_id`ï¼šç‰¹å®šç”¨æˆ¶çš„æ—¥èªŒ
     - `role`ï¼šç‰¹å®šè§’è‰²çš„æ—¥èªŒ
     - `start_time`/`end_time`ï¼šæ™‚é–“ç¯„åœï¼ˆUnix timestampï¼‰
     - `limit`ï¼šè¿”å›æ•¸é‡é™åˆ¶ï¼ˆ1-1000ï¼‰

### æ•ˆèƒ½ç›£æ§èˆ‡åˆ†æ
æœ¬å°ˆæ¡ˆæä¾›äº†å¼·å¤§çš„æ•ˆèƒ½ç›£æ§èˆ‡åˆ†æå·¥å…·ï¼Œå¹«åŠ©ç”¨æˆ¶è¿½è¹¤è¨“ç·´éç¨‹ä¸­çš„ç³»çµ±è³‡æºä½¿ç”¨æƒ…æ³å’Œæ¨¡å‹æ€§èƒ½ã€‚
`performance.py` æä¾›äº† `PerformanceMonitor` é¡ï¼Œç”¨æ–¼æ”¶é›† CPUã€è¨˜æ†¶é«”ä½¿ç”¨ç‡ä»¥åŠè¨“ç·´éç¨‹ä¸­çš„ token è™•ç†é€Ÿåº¦ã€‚
`analyze_metrics.py` æä¾›äº†åˆ†æå·¥å…·ï¼Œèƒ½å¤ å¾å¤šå€‹å¯¦é©—ä¸­æå–æ•¸æ“šä¸¦ç”Ÿæˆæ¯”è¼ƒå ±å‘Šã€‚

---

## ğŸ”§ è³‡æ–™ç®¡ç†å·¥å…·

ä»¥ä¸‹æŒ‡ä»¤ä½¿ç”¨é è¨­çš„ SST-2 ç¯„ä¾‹è³‡æ–™é›†ï¼Œåƒ…ä¾›é–‹ç™¼æ¸¬è©¦ç”¨é€”ã€‚
å¯¦éš›è¨“ç·´æ™‚ï¼Œé€™äº›åŠŸèƒ½å·²æ•´åˆåœ¨è¨“ç·´æµç¨‹ä¸­è‡ªå‹•åŸ·è¡Œã€‚

```bash
make data-analyze    # åˆ†ææ¨™ç±¤åˆ†å¸ƒ
make data-validate   # é©—è­‰è³‡æ–™å“è³ª
make data-versions   # ç®¡ç†è³‡æ–™ç‰ˆæœ¬
```

**è³‡æ–™é©—è­‰å ±å‘Šç¯„ä¾‹**ï¼š
```json
{
  "total_samples": 500,
  "label_counts": {"0": 245, "1": 255},
  "imbalance_ratio": 1.04,
  "is_balanced": true
}
```

---

## ğŸ’¡ æ³¨æ„äº‹é …

### ç’°å¢ƒè¨­ç½®
- é¦–æ¬¡ä½¿ç”¨è«‹åŸ·è¡Œ `make setup-conda` è¨­ç½®ç’°å¢ƒ
- ä½¿ç”¨ `make help` æŸ¥çœ‹å®Œæ•´çš„å‘½ä»¤èªªæ˜
- æ”¯æ´ Docker å’Œ Kubernetes éƒ¨ç½²
- ç’°å¢ƒè®Šæ•¸é…ç½®ï¼šè¤‡è£½ `.env.example` åˆ° `.env` ä¸¦æ ¹æ“šéœ€è¦èª¿æ•´

### Docker èˆ‡ Kubernetes
- ä½¿ç”¨å¤šéšæ®µæ§‹å»ºå„ªåŒ–æ˜ åƒå¤§å°å’Œæ§‹å»ºé€Ÿåº¦
- æ”¯æ´å¿«é€Ÿæ§‹å»ºï¼ˆé–‹ç™¼ç”¨ï¼‰å’Œå®Œæ•´æ§‹å»ºï¼ˆç”Ÿç”¢ç”¨ï¼‰
- Kubernetes éƒ¨ç½²æä¾›å®Œæ•´çš„æœå‹™ç®¡ç†åŠŸèƒ½
- ä½¿ç”¨ `make k8s-port-forward` ç°¡åŒ–æœå‹™è¨ªå•

### è¨“ç·´èˆ‡é…ç½®
- å¯¦é©—é…ç½®æœƒè‡ªå‹•ä¿å­˜ï¼Œæ–¹ä¾¿è¿½è¹¤å’Œé‡ç¾
- è³‡æ–™ç®¡ç†åŠŸèƒ½åœ¨è¨“ç·´æ™‚è‡ªå‹•åŸ·è¡Œï¼Œç¢ºä¿è³‡æ–™å“è³ª
- è¨“ç·´çµæœçµ±ä¸€ä¿å­˜åœ¨ `results/` ç›®éŒ„
- æ”¯æ´ç›´æ¥å‚³éè¨“ç·´é…ç½®ï¼Œç„¡éœ€è‡¨æ™‚æ–‡ä»¶

### éåŒæ­¥æœå‹™
- æ”¯æ´ Docker Compose å’Œ Kubernetes å…©ç¨®éƒ¨ç½²æ–¹å¼
- æä¾›å®Œæ•´çš„æœå‹™ç›£æ§å’Œç®¡ç†åŠŸèƒ½
- å»ºè­°ä½¿ç”¨ç¶²é ç•Œé¢æ“ä½œï¼ŒAPI æ¥å£ä¸»è¦ç”¨æ–¼ç¨‹å¼æ•´åˆ
- æœå‹™ç«¯å£å¯é€šé `.env` æ–‡ä»¶è‡ªå®šç¾©èª¿æ•´


### æ¨è«–æœå‹™

æœ¬å°ˆæ¡ˆæä¾›è¼•é‡ç´šçš„æƒ…æ„Ÿåˆ†é¡æ¨è«–æœå‹™ï¼Œæ”¯æ´å¤šç¨®é è¨“ç·´æ¨¡å‹ï¼š

- distilbert-base-uncasedï¼ˆè‹±æ–‡ï¼Œè¼•é‡ç´šï¼‰
- roberta-baseï¼ˆè‹±æ–‡ï¼Œé«˜æ€§èƒ½ï¼‰
- albert-base-v2ï¼ˆè‹±æ–‡ï¼Œè¼•é‡ç´šï¼‰
- bert-base-chineseï¼ˆä¸­æ–‡ï¼‰

1. **å•Ÿå‹•æœå‹™**ï¼š
```bash
# ä½¿ç”¨æœ€æ–°å¯¦é©—çš„æ¨¡å‹
make serve

# æˆ–æŒ‡å®šç‰¹å®šå¯¦é©—
make serve exp=default_experiment_20250911_233842
```

2. **æ¸¬è©¦é æ¸¬**ï¼š
```bash
# æª¢æŸ¥æœå‹™ç‹€æ…‹
make predict-health

# æ¸¬è©¦è‡ªè¨‚æ–‡æœ¬
make predict-text text='This movie was great!'

# ä½¿ç”¨é è¨­ç¯„ä¾‹
make predict-positive  # æ¸¬è©¦æ­£é¢è©•è«–
make predict-negative  # æ¸¬è©¦è² é¢è©•è«–
```

### å›æ‡‰æ ¼å¼

```json
{
    "label": 1,                    # 1 = positive, 0 = negative
    "probability": 0.9983,         # prediction confidence
    "latency_ms": 25.4,           # processing time (ms)
    "base_model": "distilbert-base-uncased",  # base model name
    "language": "English"          # model language
}
```

### æ³¨æ„äº‹é …

1. **æ¨¡å‹é¸æ“‡**ï¼š
   - è‹±æ–‡æ–‡æœ¬è«‹ä½¿ç”¨è‹±æ–‡æ¨¡å‹ï¼ˆdistilbert/roberta/albertï¼‰
   - ä¸­æ–‡æ–‡æœ¬è«‹ä½¿ç”¨ä¸­æ–‡æ¨¡å‹ï¼ˆbert-base-chineseï¼‰
   - æ³¨æ„æ–‡æœ¬èªè¨€è¦å’Œæ¨¡å‹èªè¨€åŒ¹é…

2. **æœå‹™é…ç½®**ï¼š
   - æœå‹™é‹è¡Œåœ¨ 8002 ç«¯å£
   - è‡ªå‹•æª¢æ¸¬ä¸¦ä½¿ç”¨ MPSï¼ˆApple Siliconï¼‰æˆ– CPU
   - æ”¯æ´æ¨¡å‹ç†±åˆ‡æ›ï¼ˆä¸éœ€é‡å•Ÿæœå‹™ï¼‰
