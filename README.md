# Finetune-30-days â€” LoRA è¨“ç·´èˆ‡å¯¦é©—ç®¡ç†

æ­¤å°ˆæ¡ˆæä¾›ä¸€å€‹å®Œæ•´çš„ **LoRA å¾®èª¿ç³»çµ±**ï¼Œæ”¯æ´ M3 æ™¶ç‰‡ (MPS)ã€NVIDIA GPU (CUDA) èˆ‡ CPUã€‚

**ä¸»è¦ç‰¹é»**ï¼š
- ğŸš€ æ”¯æ´åŒæ­¥ï¼ˆæœ¬åœ°ï¼‰èˆ‡éåŒæ­¥ï¼ˆåˆ†æ•£å¼ï¼‰è¨“ç·´
- ğŸ“Š å®Œæ•´çš„è³‡æ–™ç‰ˆæœ¬ç®¡ç†èˆ‡é©—è­‰æ©Ÿåˆ¶
- ğŸ¯ å¯¦é©—çµæœè‡ªå‹•ä¿å­˜èˆ‡è¿½è¹¤
- ğŸŒ ç¶²é ç•Œé¢æ”¯æ´ä»»å‹™æäº¤èˆ‡é€²åº¦ç›£æ§
- ğŸ”„ åŸºæ–¼ Celery + Redis çš„éåŒæ­¥ä»»å‹™ç³»çµ±
- ğŸ“ çµæ§‹åŒ–çš„é…ç½®ç®¡ç†ï¼ˆPydantic + YAMLï¼‰

---

## ğŸ”„ ç³»çµ±äº’å‹•æµç¨‹

```mermaid
sequenceDiagram
    participant U as ä½¿ç”¨è€…
    participant UI as Streamlit UI
    participant API as FastAPI
    participant C as Celery Worker
    participant T as è¨“ç·´ç¨‹å¼
    participant DB as SQLite DB
    participant R as Redis

    U->>UI: å¡«å¯«å¯¦é©—åƒæ•¸ä¸¦æäº¤
    UI->>API: POST /train (config_path, experiment_name)
    API->>C: æäº¤ Celery ä»»å‹™
    C->>R: ä»»å‹™å…¥éšŠ (task_id)
    API-->>UI: å›å‚³ task_id

    loop ä»»å‹™è¼ªè©¢
        UI->>API: GET /task/{task_id}
        API->>R: æŸ¥è©¢ç‹€æ…‹
        R-->>API: è¿”å› PENDING/STARTED
        API-->>UI: æ›´æ–° UI Stepper ç‹€æ…‹
    end

    C->>T: åŸ·è¡Œ train_lora_v2.py
    T->>DB: å¯«å…¥å¯¦é©—è¨˜éŒ„
    T->>R: æ›´æ–°ä»»å‹™çµæœ (SUCCESS)
    UI->>API: æœ€å¾ŒæŸ¥è©¢ /task/{task_id}
    API-->>UI: è¿”å› SUCCESS + å¯¦é©—çµæœ
```

---

## ğŸ“‚ å°ˆæ¡ˆçµæ§‹

```
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api.py                    # FastAPI æ‡‰ç”¨
â”‚   â”œâ”€â”€ config.py                 # é…ç½®å®šç¾©èˆ‡ç®¡ç†
â”‚   â”œâ”€â”€ data_management/         # è³‡æ–™ç®¡ç†æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ data_validator.py    # è³‡æ–™é©—è­‰èˆ‡æ¸…ç†
â”‚   â”‚   â”œâ”€â”€ dataset_analyzer.py  # æ¨™ç±¤åˆ†å¸ƒåˆ†æ
â”‚   â”‚   â””â”€â”€ version_manager.py   # è³‡æ–™ç‰ˆæœ¬æ§åˆ¶
â”‚   â”œâ”€â”€ logger_config.py         # æ—¥èªŒç³»çµ±
â”‚   â”œâ”€â”€ tasks/                   # Celery ä»»å‹™
â”‚   â”‚   â”œâ”€â”€ __init__.py         # Celery æ‡‰ç”¨é…ç½®
â”‚   â”‚   â””â”€â”€ training.py         # è¨“ç·´ä»»å‹™å®šç¾©
â”‚   â””â”€â”€ train_lora_v2.py        # LoRA è¨“ç·´ä¸»ç¨‹å¼
â”œâ”€â”€ config/
â”‚   â””â”€â”€ default.yaml              # é è¨­é…ç½®æ–‡ä»¶
â”œâ”€â”€ results/                       # å¯¦é©—çµæœç›®éŒ„
â”‚   â””â”€â”€ {å¯¦é©—åç¨±}_{æ™‚é–“æˆ³}/      # ç¨ç«‹å¯¦é©—ç›®éŒ„
â”‚       â”œâ”€â”€ logs.txt            # ç³»çµ±æ—¥èªŒèˆ‡è¨“ç·´é€²åº¦
â”‚       â”œâ”€â”€ config.yaml         # å¯¦é©—é…ç½®
â”‚       â”œâ”€â”€ metrics.json        # è©•ä¼°æŒ‡æ¨™
â”‚       â””â”€â”€ artifacts/          # æ¨¡å‹èˆ‡å…¶ä»–ç”¢å‡º
â”‚           â””â”€â”€ final_model/    # è¨“ç·´å®Œæˆçš„æ¨¡å‹
â”œâ”€â”€ requirements.txt              # ä¾è³´ç®¡ç†
â”œâ”€â”€ Makefile                      # ç°¡åŒ–æŒ‡ä»¤
â””â”€â”€ README.md
```

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### ç’°å¢ƒè¨­ç½®

1. **è¤‡è£½ç’°å¢ƒè®Šæ•¸æ–‡ä»¶**ï¼š
   ```bash
   cp .env.example .env
   ```

2. **ç·¨è¼¯ç’°å¢ƒè®Šæ•¸**ï¼ˆå¯é¸ï¼‰ï¼š
   ```bash
   # ç·¨è¼¯ .env æ–‡ä»¶ä¾†è‡ªå®šç¾©é…ç½®
   nano .env
   ```

   ä¸»è¦é…ç½®é …ç›®ï¼š
   - `REDIS_PORT`: Redis ç«¯å£ï¼ˆé è¨­ï¼š6379ï¼‰
   - `API_PORT`: API æœå‹™ç«¯å£ï¼ˆé è¨­ï¼š8000ï¼‰
   - `UI_PORT`: UI ç•Œé¢ç«¯å£ï¼ˆé è¨­ï¼š8501ï¼‰
   - `TZ`: æ™‚å€è¨­å®šï¼ˆé è¨­ï¼šAsia/Taipeiï¼‰

### åŸºæœ¬ä½¿ç”¨

1. **æœ¬åœ°ç›´æ¥è¨“ç·´**ï¼š
```bash
make setup-conda   # å»ºç«‹ Conda ç’°å¢ƒï¼ˆè‡ªå‹•åµæ¸¬ GPU/MPS/CPUï¼‰
make run-local     # ä½¿ç”¨é è¨­é…ç½®é–‹å§‹è¨“ç·´
make logs-local    # æŸ¥çœ‹æœ€æ–°å¯¦é©—çš„è¨“ç·´é€²åº¦
```

2. **éåŒæ­¥è¨“ç·´æœå‹™ï¼ˆDockerï¼‰**ï¼š
```bash
# 1. å•Ÿå‹•æ‰€æœ‰æœå‹™
make start-services  # å•Ÿå‹• Redisã€Workerã€APIã€UI æœå‹™

# 2. ä½¿ç”¨ç¶²é ç•Œé¢ï¼ˆæ¨è–¦ï¼‰
# è¨ªå• http://localhost:8501
# - æäº¤ä»»å‹™ï¼šé¸æ“‡ã€Œæäº¤ä»»å‹™ã€é ç±¤ï¼Œè¨­ç½®åƒæ•¸
# - è¿½è¹¤é€²åº¦ï¼šé¸æ“‡ã€Œè¿½è¹¤é€²åº¦ã€é ç±¤ï¼Œè¼¸å…¥ task_id
# - å¯¦é©—è¨˜éŒ„ï¼šé¸æ“‡ã€Œå¯¦é©—è¨˜éŒ„ã€é ç±¤ï¼ŒæŸ¥çœ‹æ‰€æœ‰å¯¦é©—

# 3. æˆ–ä½¿ç”¨ APIï¼ˆé€²éšï¼‰
curl -X POST http://localhost:8000/train \
  -H "Content-Type: application/json" \
  -d '{"experiment_name": "test_async", "epochs": 1}'

curl http://localhost:8000/task/{task_id}  # æŸ¥è©¢ä»»å‹™ç‹€æ…‹
```

> ğŸ’¡ **æœå‹™èªªæ˜**ï¼š
> - **Redis (localhost:6379)**ï¼šä»»å‹™ä½‡åˆ—èˆ‡çµæœå­˜å„²
>   - DB 0ï¼šä»»å‹™ä½‡åˆ—ï¼ˆbrokerï¼‰
>   - DB 1ï¼šä»»å‹™çµæœï¼ˆbackendï¼‰
> - **FastAPI (localhost:8000)**ï¼šREST API æœå‹™
> - **Streamlit UI (localhost:8501)**ï¼šç¶²é æ“ä½œç•Œé¢
>   - æ”¯æ´æ‰€æœ‰ default.yaml ä¸­çš„åƒæ•¸é…ç½®
>   - è‡ªå‹•ç”Ÿæˆè‡¨æ™‚é…ç½®æ–‡ä»¶ï¼ˆä¸ç´å…¥ç‰ˆæ§ï¼‰
>   - å³æ™‚é¡¯ç¤ºè¨“ç·´é€²åº¦ï¼ˆæ¯ 2 ç§’æ›´æ–°ï¼‰
>   - å¯¦é©—è¨˜éŒ„æŸ¥çœ‹èˆ‡ç®¡ç†

### è‡ªå®šç¾©è¨“ç·´

1. **ä¿®æ”¹é è¨­é…ç½®**ï¼š
   ç›´æ¥ç·¨è¼¯ `config/default.yaml`

2. **ä½¿ç”¨å‘½ä»¤åˆ—åƒæ•¸**ï¼š
   ```bash
   python app/train_lora_v2.py \
     --experiment_name "custom_test" \
     --learning_rate 0.001 \
     --epochs 3 \
     --train_samples 1000
   ```

### å¸¸ç”¨åƒæ•¸

```yaml
# åœ¨ config/default.yaml ä¸­å¯èª¿æ•´ï¼š

model:
  name: "distilbert-base-uncased"
  num_labels: 2

training:
  learning_rate: 5.0e-4
  num_train_epochs: 1
  per_device_train_batch_size: 2

lora:
  r: 8
  lora_alpha: 16
  target_modules: ["q_lin", "v_lin"]
  lora_dropout: 0.1
```

---

## ğŸ“Š å¯¦é©—è¨˜éŒ„

### æª”æ¡ˆç³»çµ±è¨˜éŒ„

æ¯æ¬¡è¨“ç·´æœƒè‡ªå‹•å‰µå»ºå¯¦é©—å°ˆå±¬ç›®éŒ„ï¼š`results/{å¯¦é©—åç¨±}_{æ™‚é–“æˆ³}/`

```
results/
â”œâ”€â”€ experiments.db        # SQLite è³‡æ–™åº«ï¼Œç”¨æ–¼å¯¦é©—è¿½è¹¤
â””â”€â”€ experiment_name_20240101_120000/
    â”œâ”€â”€ logs.txt           # ç³»çµ±æ—¥èªŒèˆ‡è¨“ç·´é€²åº¦
    â”œâ”€â”€ config.yaml        # æœ¬æ¬¡å¯¦é©—çš„å®Œæ•´é…ç½®
    â”œâ”€â”€ metrics.json       # è¨“ç·´çµæœèˆ‡è©•ä¼°æŒ‡æ¨™
    â””â”€â”€ artifacts/         # æ¨¡å‹èˆ‡å…¶ä»–ç”¢å‡º
        â””â”€â”€ final_model/   # è¨“ç·´å®Œæˆçš„æ¨¡å‹
```

- **ç³»çµ±æ—¥èªŒ**ï¼šè¨˜éŒ„è¨­å‚™ã€æ¨¡å‹è¼‰å…¥ã€è³‡æ–™è™•ç†ç­‰ç³»çµ±æ“ä½œ
- **è¨“ç·´é€²åº¦**ï¼šè¨˜éŒ„æ¯å€‹æ­¥é©Ÿçš„æå¤±å€¼ã€å­¸ç¿’ç‡ã€è©•ä¼°æŒ‡æ¨™ç­‰
- **å¯¦é©—é…ç½®**ï¼šåŒ…å«æ‰€æœ‰åƒæ•¸è¨­å®šï¼Œç¢ºä¿å¯¦é©—å¯é‡ç¾
- **è©•ä¼°æŒ‡æ¨™**ï¼šä¿å­˜æœ€çµ‚çš„è¨“ç·´æ™‚é–“ã€æº–ç¢ºç‡ç­‰çµæœ

### å¯¦é©—è¿½è¹¤

æä¾›å¤šç¨®æ–¹å¼æŸ¥çœ‹å¯¦é©—è¨˜éŒ„ï¼š

1. **ç¶²é ç•Œé¢**ï¼ˆæ¨è–¦ï¼‰ï¼š
   - è¨ªå• http://localhost:8501
   - åˆ‡æ›åˆ°ã€Œå¯¦é©—è¨˜éŒ„ã€é ç±¤
   - æ”¯æ´ç¯©é¸ã€æ’åºã€çµ±è¨ˆåŠŸèƒ½
   - å³æ™‚æ›´æ–°å¯¦é©—ç‹€æ…‹

2. **å‘½ä»¤åˆ—å·¥å…·**ï¼š
   ```bash
   # æŸ¥çœ‹å¯¦é©—è¨˜éŒ„ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
   make db-list
   
   # æŸ¥çœ‹æœ€æ–°å¯¦é©—çš„è¨“ç·´é€²åº¦
   make logs-local
   ```

3. **REST API**ï¼š
   ```bash
   # åˆ—å‡ºæ‰€æœ‰å¯¦é©—ï¼ˆæ”¯æ´ç¯©é¸å’Œæ’åºï¼‰
   curl "http://localhost:8000/experiments?min_accuracy=0.8&sort_by=eval_accuracy&desc=true"

   # æŸ¥è©¢å–®ä¸€å¯¦é©—
   curl http://localhost:8000/experiments/{experiment_id}

   # ç²å–å¯¦é©—çµ±è¨ˆ
   curl http://localhost:8000/experiments/stats
   ```

   æ”¯æ´çš„ç¯©é¸æ¢ä»¶ï¼š
   - `name`ï¼šå¯¦é©—åç¨±ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
   - `min_accuracy`ï¼šæœ€ä½æº–ç¢ºç‡
   - `max_runtime`ï¼šæœ€é•·è¨“ç·´æ™‚é–“
   - `start_date`/`end_date`ï¼šæ™‚é–“ç¯„åœ
   - `sort_by`ï¼šæ’åºæ¬„ä½ï¼ˆcreated_at/name/train_runtime/eval_accuracyï¼‰
   - `desc`ï¼šæ˜¯å¦é™åºæ’åº
   - `limit`ï¼šè¿”å›æ•¸é‡é™åˆ¶

---

## ğŸ”§ è³‡æ–™ç®¡ç†å·¥å…·

ä»¥ä¸‹æŒ‡ä»¤ä½¿ç”¨é è¨­çš„ SST-2 ç¯„ä¾‹è³‡æ–™é›†ï¼Œåƒ…ä¾›é–‹ç™¼æ¸¬è©¦ç”¨é€”ã€‚
å¯¦éš›è¨“ç·´æ™‚ï¼Œé€™äº›åŠŸèƒ½å·²æ•´åˆåœ¨è¨“ç·´æµç¨‹ä¸­è‡ªå‹•åŸ·è¡Œã€‚

```bash
make data-analyze    # åˆ†ææ¨™ç±¤åˆ†å¸ƒ
make data-validate   # é©—è­‰è³‡æ–™å“è³ª
make data-versions   # ç®¡ç†è³‡æ–™ç‰ˆæœ¬
```

**è³‡æ–™é©—è­‰å ±å‘Šç¯„ä¾‹**ï¼š
```json
{
  "total_samples": 500,
  "label_counts": {"0": 245, "1": 255},
  "imbalance_ratio": 1.04,
  "is_balanced": true
}
```

---

## ğŸ’¡ æ³¨æ„äº‹é …

### ç’°å¢ƒè¨­ç½®
- é¦–æ¬¡ä½¿ç”¨è«‹åŸ·è¡Œ `make setup-conda` è¨­ç½®ç’°å¢ƒ
- ä½¿ç”¨ `make help` æŸ¥çœ‹å®Œæ•´çš„å‘½ä»¤èªªæ˜
- éåŒæ­¥è¨“ç·´éœ€è¦å®‰è£ Docker å’Œ docker-compose
- ç’°å¢ƒè®Šæ•¸é…ç½®ï¼šè¤‡è£½ `.env.example` åˆ° `.env` ä¸¦æ ¹æ“šéœ€è¦èª¿æ•´

### è¨“ç·´èˆ‡é…ç½®
- å¯¦é©—é…ç½®æœƒè‡ªå‹•ä¿å­˜ï¼Œæ–¹ä¾¿è¿½è¹¤å’Œé‡ç¾
- è³‡æ–™ç®¡ç†åŠŸèƒ½åœ¨è¨“ç·´æ™‚è‡ªå‹•åŸ·è¡Œï¼Œç¢ºä¿è³‡æ–™å“è³ª
- è¨“ç·´çµæœèˆ‡åŒæ­¥æ¨¡å¼ç›¸åŒï¼Œéƒ½ä¿å­˜åœ¨ `results/` ç›®éŒ„

### éåŒæ­¥æœå‹™
- æ‰€æœ‰æœå‹™é€šé Docker Compose çµ±ä¸€ç®¡ç†ï¼Œä½¿ç”¨ç’°å¢ƒè®Šæ•¸é…ç½®
- ç¶²é ç•Œé¢ç”Ÿæˆçš„è‡¨æ™‚é…ç½®æ–‡ä»¶ï¼ˆ`config/temp_*.yaml`ï¼‰ä¸æœƒç´å…¥ç‰ˆæ§
- å»ºè­°ä½¿ç”¨ç¶²é ç•Œé¢æ“ä½œï¼ŒAPI æ¥å£ä¸»è¦ç”¨æ–¼ç¨‹å¼æ•´åˆ
- æœå‹™ç«¯å£å¯é€šé `.env` æ–‡ä»¶è‡ªå®šç¾©èª¿æ•´